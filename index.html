<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Barcode Scanner Client</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.6.0/jquery.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/quagga@0.12.1/dist/quagga.min.js"></script>
    <style>
        #interactive.viewport {
            position: relative;
            width: 100%;
            height: 300px;
        }
        #interactive.viewport > canvas, #interactive.viewport > video {
            max-width: 100%;
            width: 100%;
        }
        canvas.drawing, canvas.drawingBuffer {
            position: absolute;
            left: 0;
            top: 0;
        }
        #result_strip {
            margin-top: 10px;
        }
        #result_strip ul.thumbnails > li {
            width: 150px;
            display: inline-block;
            margin: 4px;
        }
        #result_strip ul.thumbnails > li .thumbnail {
            padding: 5px;
            border: 1px dashed #ddd;
        }
        #result_strip ul.thumbnails > li .thumbnail img {
            max-width: 140px;
        }
        #result_strip ul.thumbnails > li .thumbnail .caption {
            text-align: center;
        }

        #debug-log {
            margin-top: 20px;
            border: 1px solid #ddd;
            padding: 10px;
            height: 200px;
            overflow-y: auto;
        }
    </style>
</head>
<body>
    <div id="interactive" class="viewport"></div>
    <div id="result_strip">
        <ul class="thumbnails"></ul>
    </div>
    <div id="debug-log">
        <h3>Debug Log:</h3>
        <pre id="log-content"></pre>
    </div>
    <script>
        function debugLog(message) {
            var logContent = $('#log-content');
            logContent.append(new Date().toISOString() + ': ' + message + '\n');
            logContent.scrollTop(logContent[0].scrollHeight);
        }

        $(function() {
            var App = {
                init: function() {
                    debugLog('Initializing Quagga...');
                    Quagga.init(this.state, function(err) {
                        if (err) {
                            debugLog('Quagga initialization error: ' + err);
                            return;
                        }
                        debugLog('Quagga initialized successfully');
                        App.attachListeners();
                        Quagga.start();
                    });
                },
                attachListeners: function() {
                    var self = this;

                    $(".controls").on("click", "button.stop", function(e) {
                        e.preventDefault();
                        Quagga.stop();
                        debugLog('Quagga stopped');
                    });

                    $(".controls").on("click", "button.start", function(e) {
                        e.preventDefault();
                        Quagga.start();
                        debugLog('Quagga started');
                    });
                },
                state: {
                    inputStream: {
                        type : "LiveStream",
                        constraints: {
                            width: {min: 640},
                            height: {min: 480},
                            facingMode: "environment",
                            aspectRatio: {min: 1, max: 2}
                        }
                    },
                    locator: {
                        patchSize: "medium",
                        halfSample: true
                    },
                    numOfWorkers: 2,
                    frequency: 10,
                    decoder: {
                        readers : [
                            {format: "code_128_reader", config: {}},
                            {format: "ean_reader", config: {}},
                            {format: "ean_8_reader", config: {}},
                            {format: "code_39_reader", config: {}},
                            {format: "code_39_vin_reader", config: {}},
                            {format: "codabar_reader", config: {}},
                            {format: "upc_reader", config: {}},
                            {format: "upc_e_reader", config: {}},
                            {format: "i2of5_reader", config: {}},
                            {format: "2of5_reader", config: {}},
                            {format: "code_93_reader", config: {}}
                        ]
                    },
                    locate: true
                },
                lastResult : null
            };

            App.init();

            Quagga.onProcessed(function(result) {
                var drawingCtx = Quagga.canvas.ctx.overlay,
                    drawingCanvas = Quagga.canvas.dom.overlay;

                if (result) {
                    if (result.boxes) {
                        drawingCtx.clearRect(0, 0, parseInt(drawingCanvas.getAttribute("width")), parseInt(drawingCanvas.getAttribute("height")));
                        result.boxes.filter(function (box) {
                            return box !== result.box;
                        }).forEach(function (box) {
                            Quagga.ImageDebug.drawPath(box, {x: 0, y: 1}, drawingCtx, {color: "green", lineWidth: 2});
                        });
                    }

                    if (result.box) {
                        Quagga.ImageDebug.drawPath(result.box, {x: 0, y: 1}, drawingCtx, {color: "#00F", lineWidth: 2});
                    }

                    if (result.codeResult && result.codeResult.code) {
                        Quagga.ImageDebug.drawPath(result.line, {x: 'x', y: 'y'}, drawingCtx, {color: 'red', lineWidth: 3});
                    }
                }
            });

            Quagga.onDetected(function(result) {
                var code = result.codeResult.code;
                debugLog('Barcode detected: ' + code);

                if (App.lastResult !== code) {
                    App.lastResult = code;
                    var $node = null, canvas = Quagga.canvas.dom.image;

                    $node = $('<li><div class="thumbnail"><div class="imgWrapper"><img /></div><div class="caption"><h4 class="code"></h4></div></div></li>');
                    $node.find("img").attr("src", canvas.toDataURL());
                    $node.find("h4.code").html(code);
                    $("#result_strip ul.thumbnails").prepend($node);

                    // Send the code to the server via WebSocket
                    if (window.websocket && window.websocket.readyState === WebSocket.OPEN) {
                        window.websocket.send(code);
                        debugLog('Sent to server: ' + code);
                    } else {
                        debugLog('WebSocket not open, could not send: ' + code);
                    }
                }
            });
        });

        // WebSocket connection
        window.websocket = new WebSocket('wss://' + window.location.host);
        window.websocket.onopen = function() {
            debugLog('Connected to WebSocket server');
        };
        window.websocket.onerror = function(error) {
            debugLog('WebSocket Error: ' + error);
        };
        window.websocket.onclose = function(event) {
            debugLog('WebSocket connection closed: ' + event.reason);
        };
    </script>
</body>
</html>
